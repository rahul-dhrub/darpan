<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Join Meeting - Darpan</title>
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/device-preview.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap">
  <!-- TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <!-- BodyPix for background segmentation -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix"></script>
</head>

<body>
  <div class="home-container">
    <div class="device-preview-container">
      <div class="preview-header">
        <div>
          <h2 class="preview-title">Ready to join?</h2>
          <p class="preview-subtitle">Check your audio and video before joining</p>
        </div>
        <button id="go-back" class="preview-btn back">
          <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">arrow_back</span>
          Go Back
        </button>
      </div>

      <div class="preview-video-container">
        <video id="device-preview-video" autoplay muted playsinline></video>
        <canvas id="processed-video-canvas"></canvas>
        <div id="preview-avatar-placeholder" class="avatar-placeholder">
          <span class="material-icons">person</span>
        </div>
      </div>

      <div class="preview-controls">
        <button id="mic-toggle" class="preview-control-btn">
          <span class="material-icons">mic</span>
        </button>
        <button id="camera-toggle" class="preview-control-btn">
          <span class="material-icons">videocam</span>
        </button>
      </div>

      <div class="device-selection">
        <h3>Camera</h3>
        <select id="camera-select" class="device-select"></select>
        <p id="camera-error" class="device-error-message">No camera detected</p>

        <h3>Microphone</h3>
        <select id="microphone-select" class="device-select"></select>
        <div class="audio-meter-container">
          <div id="audio-level-meter"></div>
        </div>
        <p id="mic-error" class="device-error-message">No microphone detected</p>

        <div class="background-effects-container">
          <h3 class="background-effects-title">
            <span class="material-icons">wallpaper</span>
            Background Effects
          </h3>

          <div class="background-effects-options">
            <div class="background-effect-option none active" data-effect="none">
              <span class="material-icons">highlight_off</span>
              <div class="effect-label">None</div>
            </div>

            <div class="background-effect-option blur" data-effect="blur">
              <span class="material-icons">blur_on</span>
              <div class="effect-label">Blur</div>
            </div>

            <div class="background-effect-option color" data-effect="color">
              <span class="material-icons">format_color_fill</span>
              <div class="effect-label">Color</div>
            </div>

            <div class="background-effect-option" data-effect="image">
              <span class="material-icons">image</span>
              <div class="effect-label">Image</div>
            </div>
          </div>

          <!-- Blur background controls -->
          <div id="blur-bg-controls" class="custom-background-controls">
            <div class="blur-slider-container">
              <label for="blur-intensity">Blur Intensity:</label>
              <input type="range" id="blur-intensity" min="5" max="40" value="15" class="blur-slider">
              <span id="blur-value">15</span>
            </div>
          </div>

          <!-- Custom color background controls -->
          <div id="color-bg-controls" class="custom-background-controls">
            <div class="color-picker-container">
              <label for="background-color-picker">Select background color:</label>
              <input type="color" id="background-color-picker" value="#34a853">
            </div>

            <div class="preset-colors">
              <div class="preset-color" data-color="#34a853" style="background-color: #34a853;"></div>
              <div class="preset-color" data-color="#4285f4" style="background-color: #4285f4;"></div>
              <div class="preset-color" data-color="#ea4335" style="background-color: #ea4335;"></div>
              <div class="preset-color" data-color="#fbbc05" style="background-color: #fbbc05;"></div>
              <div class="preset-color" data-color="#673ab7" style="background-color: #673ab7;"></div>
              <div class="preset-color" data-color="#e91e63" style="background-color: #e91e63;"></div>
              <div class="preset-color" data-color="#009688" style="background-color: #009688;"></div>
              <div class="preset-color" data-color="#ff5722" style="background-color: #ff5722;"></div>
            </div>
          </div>

          <!-- Custom image background controls -->
          <div id="image-bg-controls" class="custom-background-controls">
            <div class="image-upload-container">
              <label>Choose background image:</label>
              <input type="file" id="background-image-upload" accept="image/*" style="display: none;">
              <button id="upload-image-btn" class="preview-btn" style="margin-top: 5px;">
                <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">upload</span>
                Upload Image
              </button>

              <div id="image-preview" class="image-preview"></div>

              <div class="preset-backgrounds">
                <div class="preset-background" data-image="images/backgrounds/office.jpg"
                  style="background-image: url('images/backgrounds/office.jpg');"></div>
                <div class="preset-background" data-image="images/backgrounds/beach.jpg"
                  style="background-image: url('images/backgrounds/beach.jpg');"></div>
                <div class="preset-background" data-image="images/backgrounds/mountain.jpg"
                  style="background-image: url('images/backgrounds/mountain.jpg');"></div>
                <div class="preset-background" data-image="images/backgrounds/city.jpeg"
                  style="background-image: url('images/backgrounds/city.jpeg');"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="preview-buttons"
        style="display: flex !important; justify-content: flex-end !important; margin-top: 24px !important;">
        <button id="cancel-join" class="preview-btn cancel">Cancel</button>
      </div>
    </div>
  </div>

  <div class="bottom-join-container">
    <button id="main-join-button" class="main-join-btn">
      Join Meeting
    </button>
  </div>

  <footer class="footer">
    <div class="footer-container">
      <div class="footer-section">
        <h3>Download Our App</h3>
        <p>Get the best video conferencing experience on your mobile device.</p>
        <div class="store-buttons">
          <a href="#" class="store-button">
            <span class="material-icons">android</span>
            Get it on Play Store
          </a>
          <a href="#" class="store-button">
            <span class="material-icons">phone_iphone</span>
            Download on App Store
          </a>
        </div>
      </div>
      <div class="footer-section">
        <h3>Quick Links</h3>
        <ul class="footer-links">
          <li><a href="/features">Features</a></li>
          <li><a href="/how-it-works">How it Works</a></li>
          <li><a href="/about">About Us</a></li>
          <li><a href="/contact-support">Contact Support</a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h3>Legal</h3>
        <ul class="footer-links">
          <li><a href="/terms">Terms of Service</a></li>
          <li><a href="/privacy">Privacy Policy</a></li>
          <li><a href="/cookies">Cookie Policy</a></li>
          <li><a href="/security">Security</a></li>
        </ul>
      </div>
    </div>
    <div class="footer-bottom">
      <p>&copy; 2025 Darpan. All rights reserved.</p>
    </div>
  </footer>

  <script>
    window.roomId = new URLSearchParams(window.location.search).get('room');

    if (!window.roomId) {
      window.location.href = '/home';
    }
  </script>
  
  <script type="module" src="js/device-preview-ui.js"></script>
</body>

</html>